{{ $useHeaderRow := .Get "header" }}
{{ $csv := .Get "csv" }}
{{ $file := readFile $csv }}
{{ $rows := $file | transform.Unmarshal (dict "delimiter" ",") }}
{{ $useLinks := .Get "useLinks" | default true }}
{{ $language := .Get "language" }}
{{ $moduleType := .Get "moduleType" }}
{{ $ProviderNamespaceColumnId := 0 }}
{{ $ResourceTypeColumnId := 0 }}
{{ $ModuleDisplayNameColumnId := 0 }}
{{ $ModuleNameColumnId := 0 }}
{{ $ModuleStatusColumnId := 0 }}
{{ $RepoURLColumnId := 0 }}
{{ $PublicRegistryReferenceColumnId := 0 }}
{{ $TelemetryIdPrefixColumnId := 0 }}
{{ $PrimaryModuleOwnerGHHandleColumnId := 0 }}
{{ $PrimaryModuleOwnerDisplayNameColumnId := 0 }}
{{ $SecondaryModuleOwnerGHHandleColumnId := 0 }}
{{ $SecondaryModuleOwnerDisplayNameColumnId := 0 }}
{{ $ModuleOwnersGHTeamColumnId := 0 }}
{{ $ModuleContributorsGHTeamColumnId := 0 }}
{{ $DescriptionColumnId := 0 }}
{{ $CommentsColumnId := 0 }}
{{ $hasModulesAvailable := false }}

{{ if eq $moduleType "resource" }}
  {{ $ProviderNamespaceColumnId = 0 }}
  {{ $ResourceTypeColumnId = 1 }}
  {{ $ModuleDisplayNameColumnId = 2 }}
  {{ $ModuleNameColumnId = 3 }}
  {{ $ModuleStatusColumnId = 4 }}
  {{ $RepoURLColumnId = 5 }}
  {{ $PublicRegistryReferenceColumnId = 6 }}
  {{ $TelemetryIdPrefixColumnId = 7 }}
  {{ $PrimaryModuleOwnerGHHandleColumnId = 8 }}
  {{ $PrimaryModuleOwnerDisplayNameColumnId = 9 }}
  {{ $SecondaryModuleOwnerGHHandleColumnId = 10 }}
  {{ $SecondaryModuleOwnerDisplayNameColumnId = 11 }}
  {{ $ModuleOwnersGHTeamColumnId = 12 }}
  {{ $ModuleContributorsGHTeamColumnId = 13 }}
  {{ $DescriptionColumnId = 14 }}
  {{ $CommentsColumnId = 15 }}
{{ else if eq $moduleType "pattern" }}
  {{ $ModuleDisplayNameColumnId = 0 }}
  {{ $ModuleNameColumnId = 1 }}
  {{ $ModuleStatusColumnId = 2 }}
  {{ $RepoURLColumnId = 3 }}
  {{ $PublicRegistryReferenceColumnId = 4 }}
  {{ $TelemetryIdPrefixColumnId = 5 }}
  {{ $PrimaryModuleOwnerGHHandleColumnId = 6 }}
  {{ $PrimaryModuleOwnerDisplayNameColumnId = 7 }}
  {{ $SecondaryModuleOwnerGHHandleColumnId = 8 }}
  {{ $SecondaryModuleOwnerDisplayNameColumnId = 9 }}
  {{ $ModuleOwnersGHTeamColumnId = 10 }}
  {{ $ModuleContributorsGHTeamColumnId = 11 }}
  {{ $DescriptionColumnId = 12 }}
  {{ $CommentsColumnId = 13 }}
{{ else }}
{{ errorf "The %q shortcode requires a moduleType parameter to bet set to either 'resource' or 'pattern'. See %s" .Name .Position }}
{{ end }}
{{ if eq $language "Bicep" }}
<table>
  {{ if $useHeaderRow }}
  {{ $headerRow := index $rows 0 }}
  {{ $rows = after 1 $rows }}
  <thead>
    <tr>
      <th>Module Name</th>
      <th>Telemetry ID prefix</th>
      <th>GitHub Teams for Module Owners and Contributors</th>
    </tr>
  </thead>
  {{ end }}
  {{ range $row, $rows }}
  <tr>
    <td>{{ if $useLinks }} {{ if or (eq (index $row $ModuleStatusColumnId) "Module Available :green_circle:") (eq (index $row $ModuleStatusColumnId) "Module Orphaned :eyes:") }} <a href="{{ index $row $RepoURLColumnId }}">{{ index $row $ModuleNameColumnId }}</a> {{ else }} {{ index $row $ModuleNameColumnId }} {{ end }} {{else}} {{ index $row $ModuleNameColumnId }} {{ end }} </td>
    <td><code>{{ index $row $TelemetryIdPrefixColumnId }}</code></td>
    <td>
      <code>{{ index $row $ModuleOwnersGHTeamColumnId }}</code>
      <br>
      <code>{{ index $row $ModuleContributorsGHTeamColumnId }}</code>
    </td>
    <td></td>
  </tr>
  {{ end }}
</table>
{{ else if eq $language "Terraform" }}
<table>
  {{ if $useHeaderRow }}
  {{ $headerRow := index $rows 0 }}
  {{ $rows = after 1 $rows }}
  <thead>
    <tr>
      <th>Module Name</th>
      <th>Telemetry ID prefix</th>
      <th>GitHub Teams for Module Owners and Contributors</th>
    </tr>
  </thead>
  {{ end }}
  {{ range $row, $rows }}
  <tr>
    <td>{{ if $useLinks }} {{ if or (eq (index $row $ModuleStatusColumnId) "Module Available :green_circle:") (eq (index $row $ModuleStatusColumnId) "Module Orphaned :eyes:") }} <a href="{{ index $row $PublicRegistryReferenceColumnId }}">{{ index $row $ModuleNameColumnId }}</a> {{ else }} {{ index $row $ModuleNameColumnId }} {{ end }} {{else}} {{ index $row $ModuleNameColumnId }} {{ end }} </td>
    <td><code>{{ index $row $TelemetryIdPrefixColumnId }}</code></td>
    <td>
      <code>{{ index $row $ModuleOwnersGHTeamColumnId }}</code>
      <br>
      <code>{{ index $row $ModuleContributorsGHTeamColumnId }}</code>
    </td>
    <td></td>
  </tr>
  {{ end }}
</table>
{{ else }}
{{ errorf "The %q shortcode requires a language parameter to be set either 'Bicep' or 'Terraform'. See %s" .Name .Position }}
{{ end }}
