{{- $folder := .Get "folder" -}}
{{- $recursive := default false (.Get "recursive") -}}
{{- $allFiles := slice -}}

{{- if $recursive -}}
  {{- $allFiles = partial "readDirRecursive" (dict "path" $folder "allFiles" $allFiles) -}}
{{- else -}}
  {{- $entries := readDir $folder -}}
  {{- range $entries -}}
    {{- $allFiles = $allFiles | append (printf "%s/%s" $folder .Name) -}}
  {{- end -}}
{{- end -}}

{{- $categories := slice "Contribution/Support" "Telemetry" "Naming/Composition" "CodeStyle" "Inputs/Outputs" "Testing" "Documentation" "Release/Publishing" -}}
{{- $languages := slice -}}
{{- $classes := slice "Resource" "Pattern" "Utility" -}}
{{- $counts := dict -}}

{{/*  Getting all the pages to find all the possible combinations of categories, languages, and classes.  */}}
{{- range $allFiles -}}
  {{- $file := replace . "content/" "" -}}
  {{- $page := site.GetPage $file -}}
  {{- $pageTags := $page.Params.tags -}}

  {{/*  At the end, the $categories, $languages, and $classes will have their possible values  */}}
  {{- /*  Getting one file/page at time  */}}
  {{- if $page -}}
    {{- range $pageTags -}}
      {{- if findRE `^Category-` . -}}
        {{- $category := replace . "Category-" "" -}}
        {{- if not (in $categories $category) -}}
          {{- $categories = $categories | append $category -}}
        {{- end -}}
      {{- else if findRE `^Language-` . -}}
        {{- $language := replace . "Language-" "" -}}
        {{- if not (in $languages $language) -}}
          {{- $languages = $languages | append $language -}}
        {{- end -}}
      {{- else if findRE `^Class-` . -}}
        {{- $class := replace . "Class-" "" -}}
        {{- if not (in $classes $class) -}}
          {{- $classes = $classes | append $class -}}
        {{- end -}}
      {{- end -}}
    {{- end -}}
  {{- end -}}
{{- end -}}

{{/*  Initialize $counts with zeros  */}}
{{- range $categories -}}
  {{- $category := . -}}
  {{- range $languages -}}
    {{- $language := . -}}
    {{- range $classes -}}
      {{- $class := . -}}
      {{- $key := printf "%s-%s-%s" $category $language $class -}}
      {{/*  {{- $key := slice $category $language $class -}}  */}}
      {{- $counts = merge $counts (dict $key 0) -}}
    {{- end -}}
  {{- end -}}
{{- end -}}

{{/*  {{- $counts = $counts | uniq -}}  */}}

{{- range $allFiles -}}
  {{- $file := replace . "content/" "" -}}
  {{- $page := site.GetPage $file -}}
  {{- $pageTags := $page.Params.tags -}}

  {{/*  Getting one file/page at a time  */}}
  {{- if $page -}}
    {{- $categoryTags := slice -}}
    {{- $languageTags := slice -}}
    {{- $classTags := slice -}}

    {{/*  Getting all category, language, and class tags from the page  */}}
    {{- range $pageTags -}}
      {{- if findRE `^Category-` . -}}
        {{- $categoryTags = $categoryTags | append . -}}
      {{- else if findRE `^Language-` . -}}
        {{- $languageTags = $languageTags | append . -}}
      {{- else if findRE `^Class-` . -}}
        {{- $classTags = $classTags | append . -}}
      {{- end -}}
    {{- end -}}

    {{/*  Counting all combinations of category, language, and class tags  */}}
    {{- range $categoryTags -}}
      {{- $categoryTag := . -}}
      {{- $category := replace $categoryTag "Category-" "" -}}
      {{- range $languageTags -}}
        {{- $languageTag := . -}}
        {{- $language := replace $languageTag "Language-" "" -}}
        {{- range $classTags -}}
          {{- $classTag := . -}}
          {{- $class := replace $classTag "Class-" "" -}}
          {{- $key := printf "%s-%s-%s" $category $language $class -}}
          {{- $currentCount := index $counts $key -}}
          {{- $counts = merge $counts (dict $key (add $currentCount 1)) -}}
        {{- end -}}
      {{- end -}}
    {{- end -}}
  {{- end -}}
{{- end -}}

<table>
  <thead>
    <tr>
      <th rowspan="2">Category</th>
      <th colspan="3" style="text-align: center;">Bicep</th>
      <th colspan="3" style="text-align: center;">Terraform</th>
    </tr>
    <tr>
      <th>Resource</th>
      <th>Pattern</th>
      <th>Utility</th>
      <th>Resource</th>
      <th>Pattern</th>
      <th>Utility</th>
    </tr>
  </thead>
  <tbody>
    {{- range $categories -}}
      {{- $category := . -}}
      <tr>
        <td>{{ $category }}</td>
        {{- range $languages -}}
          {{- $language := . -}}
          {{- range $classes -}}
            {{- $class := . -}}
            {{- $key := printf "%s-%s-%s" $category $language $class -}}
            {{/*  {{- $key := slice $category $language $class -}}  */}}
            <td>{{ default 0 (index $counts $key) }}</td>
          {{- end -}}
        {{- end -}}
      </tr>
    {{- end -}}
  </tbody>
</table>
