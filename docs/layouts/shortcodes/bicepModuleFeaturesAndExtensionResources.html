{{ $useHeaderRow := .Get "header" }}
{{ $featureMappingCsv := .Get "featureMappingCsv" }}
{{ $featuresFile := readFile $featureMappingCsv }}
{{ $featureRows := $featuresFile | transform.Unmarshal }}

{{- /* Load BicepResourceModules.csv to get RepoURLs */ -}}
{{ $modulesIndexCsv := .Get "modulesIndexCsv" }}
{{ $modulesIndexFile := readFile $modulesIndexCsv }}
{{ $moduleIndexRows := $modulesIndexFile | transform.Unmarshal }}
{{ $modulesHeader := index $moduleIndexRows 0 }}
{{ $moduleIndexData := after 1 $moduleIndexRows }}

{{- /* Create a map of module names to RepoURLs */ -}}
{{ $moduleUrlMap := dict }}
{{ range $moduleIndexData }}
  {{ $moduleName := index . 4 }}
  {{ $repoUrl := index . 7 }}
  {{ $moduleUrlMap = merge $moduleUrlMap (dict $moduleName $repoUrl) }}
{{ end }}

<table>
  {{- if $useHeaderRow -}}
    {{- $headerRow := index $featureRows 0 -}}
    {{- $featureRows = after 1 $featureRows -}}
    <thead> <tr> {{- range $headerRow -}} <th>{{- . -}}</th> {{- end -}} </tr> </thead>
  {{- end -}}
  {{- $lastIndex := sub (len $featureRows) 1 -}}
  {{- range $i, $row := $featureRows -}}
    <tr>
      {{- range $colIndex, $cell := $row -}}
        {{- $content := $cell -}}
        {{- if and (eq $colIndex 1) (hasPrefix $content "res/") (not (hasPrefix $content "avm/res/")) -}}
          {{- $content = replaceRE "^res/" "avm/res/" $content -}}
        {{- end -}}
        {{- if eq $i $lastIndex -}}
          <td><strong>{{- emojify $content -}}</strong></td>
        {{- else -}}
          {{- if eq $colIndex 1 -}}
            {{- $url := index $moduleUrlMap $content -}}
            {{- if $url -}}
              <td><a href="{{- $url -}}">{{- emojify $content -}}</a></td>
            {{- else -}}
              <td>{{- emojify $content -}}</td>
            {{- end -}}
          {{- else -}}
            <td>{{- emojify $content -}}</td>
          {{- end -}}
        {{- end -}}
      {{- end -}}
    </tr>
  {{- end -}}
</table>
