{{ $useHeaderRow := .Get "header" }}
{{ $csv := .Get "csv" }}
{{ $file := readFile $csv }}
{{ $rows := $file | transform.Unmarshal }}

{{- /* Load BicepResourceModules.csv to get RepoURLs */ -}}
{{ $modulesFile := readFile "/static/module-indexes/BicepResourceModules.csv" }}
{{ $modulesRows := $modulesFile | transform.Unmarshal }}
{{ $modulesHeader := index $modulesRows 0 }}
{{ $modulesData := after 1 $modulesRows }}

{{- /* Create a map of module names to RepoURLs */ -}}
{{ $moduleUrlMap := dict }}
{{ range $modulesData }}
  {{ $moduleName := index . 4 }}
  {{ $repoUrl := index . 7 }}
  {{ $moduleUrlMap = merge $moduleUrlMap (dict $moduleName $repoUrl) }}
{{ end }}

<table>
  {{- if $useHeaderRow -}}
    {{- $headerRow := index $rows 0 -}}
    {{- $rows = after 1 $rows -}}
    <thead> <tr> {{- range $headerRow -}} <th>{{- . -}}</th> {{- end -}} </tr> </thead>
  {{- end -}}
  {{- $lastIndex := sub (len $rows) 1 -}}
  {{- range $i, $row := $rows -}}
    <tr>
      {{- range $colIndex, $cell := $row -}}
        {{- $content := $cell -}}
        {{- if and (eq $colIndex 1) (hasPrefix $content "res/") (not (hasPrefix $content "avm/res/")) -}}
          {{- $content = replaceRE "^res/" "avm/res/" $content -}}
        {{- end -}}
        {{- if eq $i $lastIndex -}}
          <td><strong>{{- emojify $content -}}</strong></td>
        {{- else -}}
          {{- if eq $colIndex 1 -}}
            {{- $url := index $moduleUrlMap $content -}}
            {{- if $url -}}
              <td><a href="{{- $url -}}">{{- emojify $content -}}</a></td>
            {{- else -}}
              <td>{{- emojify $content -}}</td>
            {{- end -}}
          {{- else -}}
            <td>{{- emojify $content -}}</td>
          {{- end -}}
        {{- end -}}
      {{- end -}}
    </tr>
  {{- end -}}
</table>
